<!doctype html>
<html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin — SAM (Protected)</title>
<style>
:root{ --bg:#0b0f1a; --card:#12182a; --text:#e8eefc; --line:#29304b; --ok:#18c964; --err:#ff4d4f;}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto}
.wrap{max-width:960px;margin:24px auto;padding:0 16px}
.card{background:linear-gradient(160deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid var(--line);border-radius:14px;padding:16px;margin-bottom:16px}
.input{background:#0f1426;border:1px solid var(--line);color:#e8eefc;padding:10px 12px;border-radius:10px;width:100%}
.btn{cursor:pointer;border-radius:10px;border:1px solid var(--line);padding:10px 14px;background:#0f1426;color:#e8eefc;font-weight:600}
.btn.ghost{background:transparent}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.small{color:#9aa4c7}
.banner{padding:8px 16px;border-bottom:1px solid var(--line);background:#1a223a;color:#9aa4c7}
.table{width:100%;border-collapse:collapse}.table th,.table td{border-bottom:1px solid var(--line);padding:8px;text-align:left}
.badge{padding:2px 8px;border:1px solid var(--line);border-radius:999px;background:#0f1426;color:#9aa4c7;font-size:12px}
.right{text-align:right}
.w80{width:80px}
</style></head>
<body>
<div class="banner">Admin session is protected. Set SAM spot and planned daily % drift.</div>

<!-- Gate -->
<div id="gate" class="wrap">
  <div class="card">
    <h2>Admin Login</h2>
    <div class="row"><input id="pw" type="password" class="input" placeholder="Password"/></div>
    <div class="row"><button class="btn" onclick="tryLogin()">Enter</button><button class="btn" onclick="resetPass()">Reset</button><span id="gate-msg" class="small"></span></div>
    <div class="small">First time? Click Reset to set a new password.</div>
  </div>
  <div class="card" id="setup" style="display:none">
    <h2>Set Admin Password</h2>
    <div class="row"><input id="spw1" type="password" class="input" placeholder="New password"/></div>
    <div class="row"><input id="spw2" type="password" class="input" placeholder="Confirm password"/></div>
    <div class="row"><button class="btn" onclick="trySetup()">Save Password</button><span id="setup-msg" class="small"></span></div>
  </div>
</div>

<!-- Content -->
<div id="content" class="wrap" style="display:none">
  <div class="card">
    <h2>SAM — Spot Price</h2>
    <div class="row">
      <input id="sam" class="input" type="number" step="0.000001" placeholder="SAM/USD e.g. 0.0123"/>
      <button class="btn" id="save">Save</button>
      <span id="msg" class="small"></span>
    </div>
    <div class="small">Stored in localStorage key <code>nl.config.samUsd</code></div>
  </div>

  <div class="card">
    <h2>SAM — Planned Daily % (drift)</h2>
    <div class="row">
      <input id="plan-date" class="input" placeholder="YYYY-MM-DD"/>
      <input id="plan-change" class="input" type="number" step="0.01" placeholder="Target % for that date (e.g. 29)"/>
      <button class="btn" id="add">Add / Update</button>
      <button class="btn ghost" id="clear">Clear All</button>
    </div>
    <div id="todayBox" class="small" style="margin-top:8px"></div>
    <div id="planTable" style="margin-top:10px"></div>
    <div class="small" style="margin-top:8px">
      Saved under <code>nl.config.samPlan</code>. The app eases from 0% at 00:00 ➜ target% by 23:59 (local time).
    </div>
  </div>
</div>

<script>
/* -------- gate (unchanged) -------- */
function sha256(s){ try{ if (window.crypto && window.crypto.subtle){ var e=new TextEncoder().encode(s); return window.crypto.subtle.digest('SHA-256',e).then(function(b){ return Array.from(new Uint8Array(b)).map(function(x){return x.toString(16).padStart(2,'0')}).join(''); }); } }catch(e){} return Promise.resolve(s); }
function tryLogin(){ var pass=document.getElementById('pw').value; var saved=localStorage.getItem('nl.admin.passhash'); if(!saved){ document.getElementById('setup').style.display='block'; return; } sha256(pass).then(function(hash){ if(hash===saved){ sessionStorage.setItem('nl.admin.unlocked','1'); unlock(); } else{ document.getElementById('gate-msg').textContent='Wrong password'; } }); }
function trySetup(){ var p1=document.getElementById('spw1').value, p2=document.getElementById('spw2').value; var msg=document.getElementById('setup-msg'); msg.textContent=''; if(!p1 || p1!==p2){ msg.textContent='Check passwords'; return; } sha256(p1).then(function(hash){ localStorage.setItem('nl.admin.passhash',hash); sessionStorage.setItem('nl.admin.unlocked','1'); unlock(); }); }
function resetPass(){ localStorage.removeItem('nl.admin.passhash'); sessionStorage.removeItem('nl.admin.unlocked'); document.getElementById('setup').style.display='block'; }
function unlock(){ document.getElementById('gate').style.display='none'; document.getElementById('content').style.display='block'; paint(); }
(function(){ if(localStorage.getItem('nl.admin.passhash')){ if(sessionStorage.getItem('nl.admin.unlocked')==='1'){ unlock(); } } })();

/* -------- storage -------- */
function loadCfg(){ try{ return JSON.parse(localStorage.getItem('nl.config')||'{}'); }catch(e){ return {}; } }
function saveCfg(cfg){ localStorage.setItem('nl.config', JSON.stringify(cfg)); }

/* Backward-compat import: nl.sam.hist -> nl.config.samPlan once */
(function migrateOld(){
  try{
    var old = JSON.parse(localStorage.getItem('nl.sam.hist')||'[]');
    if (Array.isArray(old) && old.length){
      var cfg = loadCfg();
      cfg.samPlan = cfg.samPlan || {};
      old.forEach(function(x){ if (x && x.date && typeof x.change==='number'){ cfg.samPlan[x.date]=x.change; }});
      saveCfg(cfg);
      // optional: keep old key or clear it – we’ll keep it for reference
    }
  }catch(e){}
})();

/* -------- UI helpers -------- */
function isDateISO(s){ return /^\d{4}-\d{2}-\d{2}$/.test(s); }
function dayKey(d){ var y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0'); return y+'-'+m+'-'+dd; }
function fractionOfDay(now){ var d=new Date(); d.setHours(0,0,0,0); var start=d.getTime(), end=start+24*60*60*1000; var t=(now.getTime()-start)/(end-start); return Math.max(0,Math.min(1,t)); }
function easeCos01(t){ return (t<=0)?0:(t>=1)?1:0.5-0.5*Math.cos(Math.PI*t); }

/* -------- paint -------- */
function paint(){
  // spot
  var cfg=loadCfg();
  document.getElementById('sam').value = (cfg.samUsd ?? 0.01);

  // plan table
  var plan = Object.assign({}, cfg.samPlan||{});
  var rows = Object.keys(plan).sort().reverse().map(function(date){
    var pct = plan[date];
    return '<tr><td>'+date+'</td><td>'+pct+'%</td><td class="right"><button class="btn ghost" data-del="'+date+'">Delete</button></td></tr>';
  }).join('');
  document.getElementById('planTable').innerHTML =
    '<table class="table"><thead><tr><th>Date</th><th>% Target</th><th class="right">Action</th></tr></thead><tbody>'+rows+'</tbody></table>';

  // today progress preview
  var today = dayKey(new Date());
  var target = plan[today];
  if (typeof target === 'number'){
    var t = easeCos01(fractionOfDay(new Date()));
    var pctNow = (target * t).toFixed(2);
    document.getElementById('todayBox').textContent = 'Today '+today+': target '+target+'% • progress ~ '+pctNow+'% (ease-in-out)';
  } else {
    document.getElementById('todayBox').textContent = 'No plan set for today ('+today+').';
  }
}

/* -------- actions -------- */
document.getElementById('save').onclick=function(){
  var v=parseFloat(document.getElementById('sam').value);
  var msg=document.getElementById('msg'); msg.textContent='';
  if(!isFinite(v) || v<=0){ msg.textContent='Invalid number'; return; }
  var cfg=loadCfg(); cfg.samUsd=v; saveCfg(cfg); msg.textContent='Saved'; setTimeout(function(){msg.textContent='';},1200);
};

document.getElementById('add').onclick=function(){
  var d=document.getElementById('plan-date').value.trim();
  var c=parseFloat(document.getElementById('plan-change').value);
  if(!isDateISO(d)){ alert('Use YYYY-MM-DD'); return; }
  if(!isFinite(c)){ alert('Enter a number'); return; }
  var cfg=loadCfg(); cfg.samPlan = cfg.samPlan || {}; cfg.samPlan[d]=c; saveCfg(cfg); paint();
};

document.getElementById('clear').onclick=function(){
  if(!confirm('Clear all planned % dates?')) return;
  var cfg=loadCfg(); delete cfg.samPlan; saveCfg(cfg); paint();
};

document.addEventListener('click', function(e){
  var del = e.target.getAttribute('data-del');
  if(del){
    var cfg=loadCfg(); if(cfg.samPlan){ delete cfg.samPlan[del]; saveCfg(cfg); paint(); }
  }
});
</script>
</body></html>
